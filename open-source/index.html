<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="Kiwi" />
  <meta name="description" content="åˆ†äº«æŠ€æœ¯ä¸ç”Ÿæ´»" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- Open Graph Description ç®€çŸ­æ‘˜è¦-->
  
  <!-- ç”¨äºæœç´¢å¼•æ“çš„æ–‡ç« æ‘˜è¦ -->
  
  <meta name="description" content="åˆ†äº«æŠ€æœ¯ä¸ç”Ÿæ´»" />
  
  
  
  <title>
    
      å¼€æºè´¡çŒ® 
      
      
      |
    
     Kiwi&#39;s Blog
  </title>

  <link rel="apple-touch-icon" href="/images/2.jpg">
  <link rel="icon" href="/images/2.jpg">

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- å­—ä½“è®¾ç½® -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/color-scheme.css" />
  <link rel="stylesheet" href="/css/base.css" />
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/audio-visualizer.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- ä»£ç å—é£æ ¼ -->
  

  <!-- jquery3.3.1 -->
  <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>

  <!-- ä»£ç å—å¤åˆ¶ -->
  <script defer type="text/javascript" src="/plugins/clipboard.min.js"></script>
  <script defer type="text/javascript" src="/js/codeCopy.js"></script>

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>

  <link rel="stylesheet" href="/css/transition.css">
  <script src="/js/pageTransition.js"></script>
<meta name="generator" content="Hexo 7.3.0"></head>

<style>
.header {
  padding: 30px 0;  /* åŸæ¥æ˜¯50pxï¼Œæ”¹å°ä¸€ç‚¹ */
}

.avatar {
  text-align: center;
}

.avatar img {
  height: 100px;
  width: 100px;
  border-radius: 50%;
  margin: 0 auto;
  object-fit: cover;
}

/* ç§»é™¤æ˜µç§°ç›¸å…³æ ·å¼ */
.avatar .nickname {
  display: none;
}
</style>


  <body>
    <div id="app">
      <!-- æ‚¬æµ®å¯¼èˆª -->
<div class="float-nav" id="floatNav">
  <div class="nav-header">
    <div class="speech-bubble" id="musicBubble">Click me to play music</div>
    <img src="/images/kiwi-bird.png" alt="Kiwi Bird" class="kiwi-bird" id="musicTrigger">
  </div>
  <div class="nav-content">
    
      
        <a href="/" class="nav-item">é¦–é¡µ</a>
      
    
      
        <a href="/projects/" class="nav-item">é¡¹ç›®å±•ç¤º</a>
      
    
      
        <a href="/archives/" class="nav-item">æ–‡ç« åˆ—è¡¨</a>
      
    
  </div>
</div>

<style>
.float-nav {
  position: fixed;
  right: 30px;
  top: 20%;
  display: flex;
  flex-direction: column;
  align-items: center;
  z-index: var(--z-index-float-nav);
  pointer-events: auto;
}

.nav-header {
  position: relative;
  margin-bottom: 1rem;
  cursor: grab;
}

.kiwi-bird {
  width: 40px;
  height: 40px;
  transition: all 0.3s ease;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
}

.speech-bubble {
  position: absolute;
  top: -42px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-text-md-code);
  padding: 7px 14px;
  border-radius: 14px;
  font-size: 14px;
  color: var(--color-text-md-code);
  white-space: nowrap;
  opacity: 1 !important;
  visibility: visible !important;
  display: block !important;
  transition: all 0.3s ease;
  pointer-events: none;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
  font-weight: 600;
  z-index: 1000;
  border: 1px solid var(--color-text-md-code);
  animation: pulseBubble 2s infinite;
}

@keyframes pulseBubble {
  0% { transform: translateX(-50%) scale(1); }
  50% { transform: translateX(-50%) scale(1.05); }
  100% { transform: translateX(-50%) scale(1); }
}

.speech-bubble::after {
  content: '';
  position: absolute;
  bottom: -5px;
  left: 50%;
  transform: translateX(-50%);
  border-left: 5px solid transparent;
  border-right: 5px solid transparent;
  border-top: 5px solid var(--bg-text-md-code);
}

.nav-content {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  background: var(--bg-text-md-code);
  padding: 0.8rem;
  border-radius: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.nav-item {
  color: var(--color-text-sub);
  text-decoration: none;
  padding: 0.5rem 1rem;
  border-radius: 15px;
  transition: all 0.3s ease;
  text-align: center;
  font-size: 14px;
}

.nav-item:hover {
  background: var(--bg-body);
  color: var(--color-text-a-hover);
}

@media (max-width: 768px) {
  .float-nav {
    right: 15px;
  }
  
  .nav-content {
    padding: 0.6rem;
  }
  
  .nav-item {
    padding: 0.4rem 0.8rem;
    font-size: 13px;
  }
}
</style>

<!-- SVG æ»¤é•œ -->
<svg class="float-nav-filters">
  <defs>
    <filter id="marker-effect" x="-10%" y="-10%" width="120%" height="120%" filterUnits="objectBoundingBox" primitiveUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
      <feTurbulence type="fractalNoise" baseFrequency="0.02 0.15" numOctaves="2" result="noise"/>
      <feDisplacementMap in="SourceGraphic" in2="noise" scale="2" xChannelSelector="R" yChannelSelector="G"/>
    </filter>
  </defs>
</svg>

<!-- éŸ³é¢‘å…ƒç´  -->
<audio id="bgMusic" src="/music/background.wav" preload="auto"></audio> 

<!-- æ·»åŠ å†…è”è„šæœ¬ç¡®ä¿æ°”æ³¡å§‹ç»ˆå¯è§ -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const speechBubble = document.getElementById('musicBubble');
    if (speechBubble) {
      // åˆå§‹åŒ–æ—¶å¼ºåˆ¶æ˜¾ç¤º
      speechBubble.style.opacity = '1';
      speechBubble.style.visibility = 'visible';
      speechBubble.style.display = 'block';
      
      // å®šæœŸæ£€æŸ¥ç¡®ä¿æ°”æ³¡å¯è§
      setInterval(() => {
        speechBubble.style.opacity = '1';
        speechBubble.style.visibility = 'visible';
        speechBubble.style.display = 'block';
      }, 1000);
    }
  });
</script> 
      <div class="header">
        <div class="avatar">
          <a href="/">
            <img src="/images/2.jpg" alt="">
          </a>
          <div class="audio-visualizer"></div>
        </div>
      </div>

      <div class="flex-container">
        <!-- æ–‡ç« è¯¦æƒ…é¡µï¼Œå±•ç¤ºæ–‡ç« å…·ä½“å†…å®¹ï¼Œurlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
<!-- åŒæ—¶ä¸ºã€Œæ ‡ç­¾tagã€ï¼Œã€Œæœ‹å‹friendã€ï¼Œã€Œåˆ†ç±»categoriesã€ï¼Œã€Œå…³äºaboutã€é¡µé¢çš„æ‰¿è½½é¡µé¢ï¼Œå…·ä½“å±•ç¤ºå–å†³äºpage.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- æ–‡ç« å†…å®¹é¡µ urlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">å¼€æºè´¡çŒ®</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="æ›´æ–°æ—¶é—´"></i>
          2025-03-11 17:16:15
        </span>
        
      </div>
      <div class="markdown-body">
        <h2 id="ğŸŒŸ-å¼€æºé¡¹ç›®è´¡çŒ®"><a href="#ğŸŒŸ-å¼€æºé¡¹ç›®è´¡çŒ®" class="headerlink" title="ğŸŒŸ å¼€æºé¡¹ç›®è´¡çŒ®"></a>ğŸŒŸ å¼€æºé¡¹ç›®è´¡çŒ®</h2><h3 id="é¡¹ç›®ä¸€"><a href="#é¡¹ç›®ä¸€" class="headerlink" title="é¡¹ç›®ä¸€"></a>é¡¹ç›®ä¸€</h3><ul>
<li><strong>é¡¹ç›®</strong>ï¼šé¡¹ç›®åç§°å’Œç®€ä»‹</li>
<li><strong>è´¡çŒ®å†…å®¹</strong>ï¼š<ul>
<li>PR #xxxï¼šå®ç°äº†æŸåŠŸèƒ½</li>
<li>Issue #xxxï¼šä¿®å¤äº†æŸé—®é¢˜</li>
</ul>
</li>
<li><strong>æŠ€æœ¯è¦ç‚¹</strong>ï¼šæ¶‰åŠçš„æŠ€æœ¯ç»†èŠ‚</li>
<li><strong>é“¾æ¥</strong>ï¼š<a href="#">é¡¹ç›®åœ°å€</a></li>
</ul>
<h3 id="é¡¹ç›®äºŒ"><a href="#é¡¹ç›®äºŒ" class="headerlink" title="é¡¹ç›®äºŒ"></a>é¡¹ç›®äºŒ</h3><ul>
<li><strong>é¡¹ç›®</strong>ï¼šé¡¹ç›®åç§°å’Œç®€ä»‹</li>
<li><strong>è´¡çŒ®å†…å®¹</strong>ï¼š<ul>
<li>PR #xxxï¼šæ”¹è¿›äº†æŸåŠŸèƒ½</li>
<li>Issue #xxxï¼šä¼˜åŒ–äº†æŸéƒ¨åˆ†</li>
</ul>
</li>
<li><strong>æŠ€æœ¯è¦ç‚¹</strong>ï¼šæ¶‰åŠçš„æŠ€æœ¯ç»†èŠ‚</li>
<li><strong>é“¾æ¥</strong>ï¼š<a href="#">é¡¹ç›®åœ°å€</a></li>
</ul>
<h2 id="ğŸ“š-æŠ€æœ¯æ–‡ç« è´¡çŒ®"><a href="#ğŸ“š-æŠ€æœ¯æ–‡ç« è´¡çŒ®" class="headerlink" title="ğŸ“š æŠ€æœ¯æ–‡ç« è´¡çŒ®"></a>ğŸ“š æŠ€æœ¯æ–‡ç« è´¡çŒ®</h2><h3 id="æ–‡ç« ä¸€"><a href="#æ–‡ç« ä¸€" class="headerlink" title="æ–‡ç« ä¸€"></a>æ–‡ç« ä¸€</h3><ul>
<li><strong>å¹³å°</strong>ï¼šå‘å¸ƒå¹³å°</li>
<li><strong>ä¸»é¢˜</strong>ï¼šæ–‡ç« ä¸»é¢˜</li>
<li><strong>å†…å®¹æ¦‚è¦</strong>ï¼šä¸»è¦è®²è¿°äº†ä»€ä¹ˆ</li>
<li><strong>é“¾æ¥</strong>ï¼š<a href="#">æ–‡ç« åœ°å€</a></li>
</ul>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="æ›´æ–°æ—¶é—´"></i>
              2025-03-11 17:16:15
            </span>
            
          </div>
          <div class="post-foot-prev">
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">ç›®å½•</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8C%9F-%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E8%B4%A1%E7%8C%AE"><span class="toc-text">ğŸŒŸ å¼€æºé¡¹ç›®è´¡çŒ®</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%B8%80"><span class="toc-text">é¡¹ç›®ä¸€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%BA%8C"><span class="toc-text">é¡¹ç›®äºŒ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%93%9A-%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0%E8%B4%A1%E7%8C%AE"><span class="toc-text">ğŸ“š æŠ€æœ¯æ–‡ç« è´¡çŒ®</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E7%AB%A0%E4%B8%80"><span class="toc-text">æ–‡ç« ä¸€</span></a></li></ol></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
  </div>


      </div>

      
<div class="footer">
  
    <div class="social">
      <ul>
        
          <li>
            <a target="_blank" rel="noopener" href="https://github.com/kwiwdn">
              <i class="iconfont icon-github"></i>
            </a>
          </li>
        
      </ul>
    </div>
  

  
    
      
      <div class="footer-more">
        <a href="/">
          Copyright Â© 2025 Kiwi
        </a>
      </div>
    
      
      <div class="footer-more">
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">
          Powered by Hexo | Theme by Oranges
        </a>
      </div>
    
  

  
</div>

    </div>

    
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>




    <script src="/js/activeNav.js"></script>
    <script src="/js/floatNav.js"></script>
    
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const avatarImg = document.querySelector('.avatar img');
        const musicTrigger = document.getElementById('musicTrigger');
        const audio = new Audio('/music/background.mp3');
        // è®¾ç½®é»˜è®¤éŸ³é‡ä¸º 30%
        audio.volume = 0.3;
        let isPlaying = false;
        let audioContext, analyser, source;
        let lastBeatTime = 0;
        let beatCount = 0;  // ç”¨äºè·Ÿè¸ªèŠ‚æ‹è®¡æ•°
        let bpm = 0;
        let beatInterval = 0;
        let energyHistory = [];
        const BEAT_THRESHOLD = 1.5;  // èŠ‚æ‹æ£€æµ‹é˜ˆå€¼
        const HISTORY_SIZE = 20;     // èƒ½é‡å†å²è®°å½•å¤§å°
        const BPM_HISTORY_SIZE = 8;  // BPMå†å²è®°å½•å¤§å°
        let bpmHistory = [];         // ç”¨äºå¹³æ»‘BPMå€¼

        // åˆå§‹åŒ–éŸ³é¢‘åˆ†æå™¨
        function initAudioAnalyser() {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          analyser = audioContext.createAnalyser();
          source = audioContext.createMediaElementSource(audio);
          
          // åˆ›å»ºå¢ç›ŠèŠ‚ç‚¹æ¥æ§åˆ¶éŸ³é‡
          const gainNode = audioContext.createGain();
          gainNode.gain.value = 0.3;
          
          // è®¾ç½®æ›´é«˜çš„FFTå¤§å°ä»¥è·å¾—æ›´å¥½çš„é¢‘ç‡åˆ†è¾¨ç‡
          analyser.fftSize = 1024;
          // è®¾ç½®å¹³æ»‘æ—¶é—´å¸¸æ•°ä»¥å‡å°‘æŠ–åŠ¨
          analyser.smoothingTimeConstant = 0.85;
          
          source.connect(analyser);
          analyser.connect(gainNode);
          gainNode.connect(audioContext.destination);
        }

        // è®¡ç®—å¹³å‡BPM
        function updateBPM(newInterval) {
          const bpmValue = 60 / newInterval;
          bpmHistory.push(bpmValue);
          if (bpmHistory.length > BPM_HISTORY_SIZE) {
            bpmHistory.shift();
          }
          // è®¡ç®—å¹³å‡BPMï¼Œæ’é™¤å¼‚å¸¸å€¼
          const sortedBPM = [...bpmHistory].sort((a, b) => a - b);
          const validBPM = sortedBPM.slice(1, -1); // å»é™¤æœ€é«˜å’Œæœ€ä½å€¼
          bpm = validBPM.reduce((a, b) => a + b, 0) / validBPM.length;
        }

        // æ£€æµ‹èŠ‚æ‹
        function detectBeat(frequencyData) {
          // è®¡ç®—å½“å‰å¸§çš„èƒ½é‡
          const currentEnergy = frequencyData.slice(0, 8).reduce((acc, val) => acc + val, 0);
          
          // æ›´æ–°èƒ½é‡å†å²
          energyHistory.push(currentEnergy);
          if (energyHistory.length > HISTORY_SIZE) {
            energyHistory.shift();
          }
          
          // è®¡ç®—å¹³å‡èƒ½é‡
          const avgEnergy = energyHistory.reduce((acc, val) => acc + val, 0) / energyHistory.length;
          
          // æ£€æµ‹èŠ‚æ‹
          const now = audioContext.currentTime;
          if (currentEnergy > avgEnergy * BEAT_THRESHOLD && now - lastBeatTime > 0.2) {
            const newInterval = now - lastBeatTime;
            updateBPM(newInterval);
            lastBeatTime = now;
            beatCount = (beatCount + 1) % 4; // å‡è®¾æ˜¯4/4æ‹
            return true;
          }
          return false;
        }

        // è·å–å½“å‰èŠ‚æ‹çš„å¼ºåº¦ç³»æ•°
        function getBeatStrength() {
          // åœ¨4/4æ‹ä¸­ï¼šç¬¬1æ‹æœ€å¼ºï¼Œç¬¬3æ‹æ¬¡å¼ºï¼Œç¬¬2å’Œç¬¬4æ‹æœ€å¼±
          switch(beatCount) {
            case 0: return 1.0;    // å¼ºæ‹
            case 2: return 0.8;    // æ¬¡å¼ºæ‹
            default: return 0.6;   // å¼±æ‹
          }
        }

        // æ›´æ–°å‘å…‰æ•ˆæœ
        function updateGlow() {
          if (isPlaying) {
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            // åˆ†æä¸åŒé¢‘æ®µ
            const bassRange = dataArray.slice(0, 4);    // ä½é¢‘èŒƒå›´ç¼©å°ï¼Œæ›´ä¸“æ³¨äºèŠ‚å¥
            const midRange = dataArray.slice(4, 32);    // æ‰©å¤§ä¸­é¢‘èŒƒå›´
            const trebleRange = dataArray.slice(32, 64); // æ‰©å¤§é«˜é¢‘èŒƒå›´
            
            const bassAvg = bassRange.reduce((acc, val) => acc + val, 0) / bassRange.length;
            const normalizedBassAvg = bassAvg / 255;
            
            // æ£€æµ‹èŠ‚æ‹
            const isBeat = detectBeat(dataArray);
            
            // è®¡ç®—å‘å…‰å¼ºåº¦
            let glowIntensity = 20 + (bassAvg / 255) * 120;
            if (isBeat) {
              glowIntensity *= getBeatStrength() * 2;
            }
            
            // ä½¿ç”¨å›ºå®šçš„é¢œè‰²
            avatarImg.style.boxShadow = `
              0 0 ${glowIntensity * 0.3}px var(--color-text-md-code),
              0 0 ${glowIntensity * 0.6}px var(--color-text-md-code),
              0 0 ${glowIntensity}px var(--color-text-md-code)
            `;
            
            // é‡å†™åŠ¨ç”»é€»è¾‘ - æ›´è‡ªç„¶åœ°è·ŸéšéŸ³ä¹å˜åŒ–
            const minScale = 0.5;  // ä¿®æ”¹æœ€å°å€¼ä¸º0.5
            const maxScale = 0.9;  // ä¿®æ”¹æœ€å¤§å€¼ä¸º0.9
            
            // åˆ†æå¤šä¸ªé¢‘æ®µï¼Œè·å–æ›´å…¨é¢çš„éŸ³ä¹ä¿¡æ¯
            const lowFreq = bassRange.reduce((acc, val) => acc + val, 0) / bassRange.length / 255;
            const midFreq = midRange.reduce((acc, val) => acc + val, 0) / midRange.length / 255;
            const highFreq = trebleRange.reduce((acc, val) => acc + val, 0) / trebleRange.length / 255;
            
            // è¿½è¸ªé¢‘ç‡å˜åŒ–ç‡ - ä¸ºæ¯ä¸ªé¢‘æ®µå•ç‹¬å­˜å‚¨å†å²
            if (!this.freqHistory) {
              this.freqHistory = {
                low: [lowFreq],
                mid: [midFreq],
                high: [highFreq]
              };
              this.changeRates = { low: 0, mid: 0, high: 0 };
              this.lastTime = audioContext.currentTime;
              this.pulseDirection = 1; // æ–°å¢ï¼šè„‰å†²æ–¹å‘
              this.pulseMagnitude = 0; // æ–°å¢ï¼šè„‰å†²å¼ºåº¦
            } else {
              // è®¡ç®—å„é¢‘æ®µå˜åŒ–ç‡
              const dt = audioContext.currentTime - this.lastTime;
              this.lastTime = audioContext.currentTime;
              
              // æ·»åŠ å½“å‰å€¼åˆ°å†å²
              this.freqHistory.low.push(lowFreq);
              this.freqHistory.mid.push(midFreq);
              this.freqHistory.high.push(highFreq);
              
              // ä¿æŒå†å²é•¿åº¦
              if (this.freqHistory.low.length > 5) {
                this.freqHistory.low.shift();
                this.freqHistory.mid.shift();
                this.freqHistory.high.shift();
              }
              
              // è®¡ç®—å˜åŒ–ç‡ - å¢å¼ºå‰§çƒˆç¨‹åº¦
              const getLowDelta = () => {
                const hist = this.freqHistory.low;
                const recent = hist.slice(-2); // åªæ¯”è¾ƒæœ€è¿‘ä¸¤å¸§
                const oldest = hist.slice(0, -2);
                return Math.max(0, (recent.reduce((a, b) => a + b, 0) / recent.length) - 
                               (oldest.reduce((a, b) => a + b, 0) / oldest.length));
              };
              
              // æ”¾å¤§å˜åŒ–ç‡ï¼Œä½¿å¹…åº¦å˜åŒ–æ›´å‰§çƒˆ
              this.changeRates.low = getLowDelta() * 5; // ä»3å¢å¤§åˆ°5
              
              // æ›´æ–°è„‰å†²æ–¹å‘å’Œå¼ºåº¦
              if (this.changeRates.low > 0.05) {
                // æ£€æµ‹åˆ°æ˜æ˜¾å˜åŒ–ï¼Œè§¦å‘è„‰å†²
                this.pulseDirection = 1;
                this.pulseMagnitude = Math.min(this.changeRates.low * 4, 0.4); // æ”¾å¤§è„‰å†²å¼ºåº¦
              } else {
                // é€æ¸å‡å¼±è„‰å†²
                this.pulseMagnitude *= 0.9;
                if (this.pulseMagnitude < 0.02) {
                  this.pulseDirection = -1;
                }
              }
            }
            
            // åŸºç¡€å€¼ä½¿ç”¨å½“å‰ä½é¢‘èƒ½é‡ï¼Œéçº¿æ€§æ˜ å°„
            const energyScale = minScale + Math.pow(lowFreq, 0.5) * (maxScale - minScale) * 1.5;
            
            // ç»“åˆè„‰å†²æ•ˆæœ
            let scale = energyScale;
            if (this.pulseDirection > 0 && this.pulseMagnitude > 0.02) {
              // æ·»åŠ è„‰å†²å¢å¼º
              scale += this.pulseMagnitude;
            }
            
            // æ£€æµ‹åˆ°èŠ‚æ‹æ—¶æ·»åŠ æ˜æ˜¾çš„é¢å¤–è„‰å†²
            if (isBeat) {
              // èŠ‚æ‹æ—¶é¢å¤–æå‡ï¼Œä½¿èŠ‚æ‹æ„Ÿæ›´æ˜æ˜¾
              const beatBoost = getBeatStrength() * 0.35; // ä»0.3å¢åŠ åˆ°0.35
              scale += beatBoost;
              
              // é‡ç½®è„‰å†²çŠ¶æ€
              this.pulseDirection = 1;
              this.pulseMagnitude = Math.max(this.pulseMagnitude, beatBoost);
              
              // èŠ‚æ‹æ—¶æ˜æ˜¾å¢å¼ºå…‰æ™•
              avatarImg.style.boxShadow = `
                0 0 ${glowIntensity * 0.6}px var(--color-text-md-code),
                0 0 ${glowIntensity * 0.9}px var(--color-text-md-code),
                0 0 ${glowIntensity * 1.4}px var(--color-text-md-code)
              `;
            }
            
            // ä½¿ç”¨å“åº”é€Ÿåº¦æ›´å¿«çš„å¹³æ»‘è¿‡æ¸¡
            if (!this.currentScale) {
              this.currentScale = scale;
            } else {
              // æ›´å¿«çš„å“åº”å’Œæ›´æ˜æ˜¾çš„å˜åŒ–
              const upFactor = 0.4;   // ä¸Šå‡æ—¶å¿«é€Ÿå“åº”(ä»0.5æ”¹ä¸º0.4)
              const downFactor = 0.7; // ä¸‹é™æ—¶ä¸­ç­‰é€Ÿåº¦(ä»0.8æ”¹ä¸º0.7)
              const smoothFactor = scale > this.currentScale ? upFactor : downFactor;
              this.currentScale = this.currentScale * smoothFactor + scale * (1 - smoothFactor);
            }
            
            // æ·»åŠ å¼ºåˆ¶æ”¶ç¼©é€»è¾‘ï¼Œç¡®ä¿æœ‰æ˜æ˜¾çš„æ”¶ç¼©è¿‡ç¨‹
            if (this.pulseDirection < 0 && this.currentScale > minScale + 0.05) {
              // å½“å¤„äºæ”¶ç¼©é˜¶æ®µä¸”å°šæœªæ¥è¿‘æœ€å°å€¼æ—¶ï¼ŒåŠ é€Ÿæ”¶ç¼©
              this.currentScale = Math.max(minScale, this.currentScale * 0.95);
            }
            
            // åº”ç”¨ç¼©æ”¾ï¼Œç¡®ä¿ä¸è¶…å‡ºèŒƒå›´
            this.currentScale = Math.max(minScale, Math.min(maxScale + 0.1, this.currentScale));
            avatarImg.style.transform = `scale(${this.currentScale})`;
            
            requestAnimationFrame(updateGlow);
          }
        }

        // é‡ç½®æ’­æ”¾çŠ¶æ€
        function resetPlayState() {
          isPlaying = false;
          avatarImg.classList.remove('playing');
          musicTrigger.classList.remove('active');
          avatarImg.style.boxShadow = 'none';
          avatarImg.style.transform = 'scale(1)';
          energyHistory = [];
          bpmHistory = [];
          beatCount = 0;
          lastBeatTime = 0;
          bpm = 0;
          
          // æ›´æ–°æ°”æ³¡æ–‡æœ¬
          const musicBubble = document.getElementById('musicBubble');
          if (musicBubble) {
            musicBubble.textContent = 'Click me to play music';
          }
        }

        // ç‚¹å‡»å°é¸Ÿå›¾æ ‡æ’­æ”¾/æš‚åœ
        musicTrigger.addEventListener('click', async function() {
          const musicBubble = document.getElementById('musicBubble');
          
          if (!isPlaying) {
            try {
              if (!audioContext) {
                initAudioAnalyser();
              }
              if (audioContext.state === 'suspended') {
                await audioContext.resume();
              }
              await audio.play();
              avatarImg.classList.add('playing');
              musicTrigger.classList.add('active');
              isPlaying = true;
              
              // æ›´æ–°æ°”æ³¡æ–‡æœ¬ä¸ºåœæ­¢æŒ‡ç¤º
              if (musicBubble) {
                musicBubble.textContent = 'Click me to stop';
              }
              
              updateGlow();
            } catch (error) {
              console.error('æ’­æ”¾å¤±è´¥:', error);
              resetPlayState();
            }
          } else {
            audio.pause();
            resetPlayState();
          }
        });

        // ç›‘å¬éŸ³é¢‘ç»“æŸ
        audio.addEventListener('ended', function() {
          resetPlayState();
        });

        // ç›‘å¬éŸ³é¢‘é”™è¯¯
        audio.addEventListener('error', function(error) {
          console.error('éŸ³é¢‘åŠ è½½é”™è¯¯:', error);
          resetPlayState();
        });

        // ç¦ç”¨ç”¨æˆ·éŸ³é‡æ§åˆ¶
        audio.addEventListener('volumechange', function(e) {
          if (audio.volume !== 0.3) {
            audio.volume = 0.3;
          }
        });
      });
    </script>
  </body>
</html>
